#!/usr/bin/env node

const fs = require("fs");
const path = require("path");
const { obfuscate } = require("../src/index");

function printHelp() {
  const text = `
Usage:
  js-obf <input.js|input.lua|input.luau|-> [options]

Options:
  -o, --output <file>        Output file
  --preset <high|balanced|low>  Preset strength (default: high)
  --no-rename                Disable identifier renaming
  --rename-globals           Rename global bindings (Luau only)
  --no-rename-globals        Skip renaming globals
  --rename-members           Rename member/table keys (Luau only)
  --no-rename-members        Skip renaming members
  --rename-homoglyphs        Use l/I/1 homoglyph alphabet (Luau only)
  --no-rename-homoglyphs     Disable homoglyph alphabet
  --mask-globals             Mask global reads via _ENV (Luau only)
  --no-mask-globals          Skip masking global reads
  --no-strings               Disable string encoding
  --strings-split            Split long strings into fragments (Luau)
  --no-strings-split         Disable string splitting
  --strings-split-min <n>    Minimum length to split (Luau, default 12)
  --strings-split-max-parts <n>  Max fragments (Luau, default 3)
  --strings-segment-size <n>    Max entries per Luau string pool (default 120)
  --strings-value-fallback      Encode StringLiteral.value when raw is missing (Luau, default on)
  --no-strings-value-fallback   Disable value fallback for string encoding (Luau)
  --const-array              Extract constants into a table (Luau)
  --no-const-array           Disable constant extraction (Luau)
  --const-array-threshold <0-1>  Constant extraction probability (default 1)
  --const-array-strings-only  Extract strings only (Luau)
  --no-const-array-strings-only  Include numbers/booleans (Luau)
  --const-array-shuffle      Shuffle constant table (default on)
  --no-const-array-shuffle   Disable constant shuffle
  --const-array-rotate       Rotate constant table (default on)
  --no-const-array-rotate    Disable constant rotate
  --const-array-encoding <none|base64>  Encode string constants (Luau)
  --const-array-wrapper      Wrap indices with offset indirection (default on)
  --no-const-array-wrapper   Disable wrapper indirection
  --numbers-expr             Convert numeric literals to expressions (Luau)
  --no-numbers-expr          Disable numeric expression conversion (Luau)
  --numbers-expr-threshold <0-1>  Numeric conversion probability (default 1)
  --numbers-expr-inner <0-1>  Nested conversion probability (default 0.2)
  --numbers-expr-max-depth <n>  Max nested depth (default 6)
  --no-strings-object-keys   Skip encoding object literal keys
  --strings-object-keys      Force encoding object literal keys
  --no-strings-jsx-attrs     Skip encoding JSX attribute string values
  --strings-jsx-attrs        Force encoding JSX attribute string values
  --no-strings-template-chunks  Skip encoding template literal static chunks
  --strings-template-chunks     Force encoding template literal static chunks
  --wrap                      Wrap chunk in a function (Luau only)
  --wrap-iterations <n>        Wrap iterations (Luau only, default 1)
  --proxify-locals             Proxy local variables via table indirection (Luau only)
  --no-proxify-locals          Disable proxy locals (Luau only)
  --pad-footer                 Append fake Luau blocks after real code (Luau only)
  --no-pad-footer              Disable footer padding
  --pad-footer-blocks <n>       Number of fake blocks (Luau only, default 2)
  --no-cff                   Disable control flow flattening
  --cff-downlevel            Allow CFF to downlevel let/const to var
  --cff-mode <vm|classic>    CFF strategy for Luau (default: vm)
  --cff-opaque               Enable opaque predicates (default: on)
  --no-cff-opaque            Disable opaque predicates
  --no-dead                  Disable dead code injection
  --vm                       Enable VM virtualization (see README limits)
  --vm-layers <n>            VM layers (Luau, default 1)
  --vm-top-level             Virtualize Luau top-level chunk
  --no-vm-top-level          Do not virtualize Luau top-level chunk (default)
  --vm-include <a,b,c>        Only virtualize specified function names
  --vm-opcode-shuffle        Enable VM opcode shuffle (default: on)
  --no-vm-opcode-shuffle     Disable VM opcode shuffle
  --vm-fake-opcodes <0-1>    Fake opcode insertion probability (default: 0.15)
  --vm-bytecode              Encrypt VM bytecode at runtime (default: on)
  --no-vm-bytecode           Disable VM bytecode encryption
  --vm-consts                Encrypt VM const pool at runtime (default: on)
  --no-vm-consts             Disable VM const pool encryption
  --vm-consts-encoding <table|string>  VM const pool storage (default table)
  --vm-consts-split          Split VM const pool into parts (default on)
  --no-vm-consts-split       Disable VM const pool splitting
  --vm-consts-split-size <n>  Approximate const chunk size (default 24)
  --vm-runtime-key           Runtime key for Luau VM bytecode (default: on)
  --no-vm-runtime-key        Disable runtime key for Luau VM bytecode
  --vm-runtime-split         Split Luau VM bytecode into parts (default: on)
  --no-vm-runtime-split      Disable runtime bytecode split
  --vm-decoy-runtime         Inject fake VM/runtime bait blocks (default: on)
  --no-vm-decoy-runtime      Disable fake VM/runtime bait blocks
  --vm-decoy-probability <0-1>  Probability of decoy VM bait insertion (default: 0.85)
  --vm-decoy-strings <n>     Number of fake decoy VM strings (default: 12)
  --vm-numeric-style <plain|mixed|chaos>  Numeric literal style for Luau VM output
  --vm-dispatch-graph <auto|tree|sparse>  Luau VM dispatch graph style
  --vm-stack-protocol <auto|direct|api>   Luau VM stack protocol style
  --vm-isa-polymorph         Enable polymorphic Luau VM ISA variants
  --no-vm-isa-polymorph      Disable polymorphic Luau VM ISA variants
  --vm-fake-edges            Enable fake edges in sparse Luau dispatch graph
  --no-vm-fake-edges         Disable fake edges in sparse Luau dispatch graph
  --vm-block-dispatch         Use block-dispatch VM (Luau, hides bytecode table)
  --no-vm-block-dispatch      Use table-driven VM (default)
  --vm-downlevel             Allow VM to downlevel let/const to var
  --vm-debug                 Log Luau VM compile failures
  --anti-hook                Enable anti-hook runtime guard
  --anti-hook-lock           Freeze built-in prototypes after guard
  --lang <js|luau>            Select language (default: js, inferred from .lua/.luau)
  --seed <value>              RNG seed
  --ecma <version>           Terser output ECMAScript version (default: 2020)
  --sourcemap                Emit source map
  --compact                  Compact output (JS) / one-line Luau
  --no-minify                Skip Terser minification
  --beautify                 Beautify Terser output (multi-line, requires minify)
  --timing                   Print per-plugin timings (ms precision, default on)
  --no-timing                Disable per-plugin timings
  -h, --help                 Show help
`;
  process.stdout.write(text);
}

function parseArgs(argv) {
  const args = argv.slice(2);
  const options = {
    preset: "high",
  };
  const positional = [];

  for (let i = 0; i < args.length; i += 1) {
    const arg = args[i];
    if (arg === "-h" || arg === "--help") {
      options.help = true;
      continue;
    }
    if (arg === "-o" || arg === "--output") {
      options.output = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--preset") {
      options.preset = args[i + 1] || "high";
      i += 1;
      continue;
    }
    if (arg === "--seed") {
      options.seed = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--lang") {
      options.lang = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--luau") {
      options.lang = "luau";
      continue;
    }
    if (arg.startsWith("--luau-parser=")) {
      continue;
    }
    if (arg === "--luau-parser") {
      i += 1;
      continue;
    }
    if (arg === "--ecma") {
      options.ecma = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--sourcemap") {
      options.sourcemap = true;
      continue;
    }
    if (arg === "--compact") {
      options.compact = true;
      continue;
    }
    if (arg === "--no-minify") {
      options.minify = false;
      continue;
    }
    if (arg === "--beautify") {
      options.beautify = true;
      continue;
    }
    if (arg === "--timing" || arg === "--timings") {
      options.timing = true;
      continue;
    }
    if (arg === "--no-timing") {
      options.timing = false;
      continue;
    }
    if (arg === "--vm") {
      options.vm = true;
      continue;
    }
    if (arg === "--vm-layers") {
      options.vmLayers = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--vm-top-level") {
      options.vmTopLevel = true;
      continue;
    }
    if (arg === "--no-vm-top-level") {
      options.vmTopLevel = false;
      continue;
    }
    if (arg === "--vm-include") {
      options.vmInclude = (args[i + 1] || "").split(",").filter(Boolean);
      i += 1;
      continue;
    }
    if (arg === "--vm-opcode-shuffle") {
      options.vmOpcodeShuffle = true;
      continue;
    }
    if (arg === "--no-vm-opcode-shuffle") {
      options.vmOpcodeShuffle = false;
      continue;
    }
    if (arg === "--vm-fake-opcodes") {
      options.vmFakeOpcodes = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--vm-bytecode") {
      options.vmBytecode = true;
      continue;
    }
    if (arg === "--no-vm-bytecode") {
      options.vmBytecode = false;
      continue;
    }
    if (arg === "--vm-consts") {
      options.vmConsts = true;
      continue;
    }
    if (arg === "--no-vm-consts") {
      options.vmConsts = false;
      continue;
    }
    if (arg === "--vm-consts-encoding") {
      options.vmConstsEncoding = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--vm-consts-split") {
      options.vmConstsSplit = true;
      continue;
    }
    if (arg === "--no-vm-consts-split") {
      options.vmConstsSplit = false;
      continue;
    }
    if (arg === "--vm-consts-split-size") {
      options.vmConstsSplitSize = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--vm-runtime-key") {
      options.vmRuntimeKey = true;
      continue;
    }
    if (arg === "--no-vm-runtime-key") {
      options.vmRuntimeKey = false;
      continue;
    }
    if (arg === "--vm-runtime-split") {
      options.vmRuntimeSplit = true;
      continue;
    }
    if (arg === "--no-vm-runtime-split") {
      options.vmRuntimeSplit = false;
      continue;
    }
    if (arg === "--vm-decoy-runtime") {
      options.vmDecoyRuntime = true;
      continue;
    }
    if (arg === "--no-vm-decoy-runtime") {
      options.vmDecoyRuntime = false;
      continue;
    }
    if (arg === "--vm-decoy-probability") {
      options.vmDecoyProbability = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--vm-decoy-strings") {
      options.vmDecoyStrings = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--vm-dispatch-graph") {
      options.vmDispatchGraph = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--vm-stack-protocol") {
      options.vmStackProtocol = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--vm-isa-polymorph") {
      options.vmIsaPolymorph = true;
      continue;
    }
    if (arg === "--no-vm-isa-polymorph") {
      options.vmIsaPolymorph = false;
      continue;
    }
    if (arg === "--vm-fake-edges") {
      options.vmFakeEdges = true;
      continue;
    }
    if (arg === "--no-vm-fake-edges") {
      options.vmFakeEdges = false;
      continue;
    }
    if (arg === "--vm-block-dispatch") {
      options.vmBlockDispatch = true;
      continue;
    }
    if (arg === "--no-vm-block-dispatch") {
      options.vmBlockDispatch = false;
      continue;
    }
    if (arg === "--vm-downlevel") {
      options.vmDownlevel = true;
      continue;
    }
    if (arg === "--vm-debug") {
      options.vmDebug = true;
      continue;
    }
    if (arg === "--vm-numeric-style") {
      options.vmNumericStyle = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--no-rename") {
      options.rename = false;
      continue;
    }
    if (arg === "--rename-globals") {
      options.renameGlobals = true;
      continue;
    }
    if (arg === "--no-rename-globals") {
      options.renameGlobals = false;
      continue;
    }
    if (arg === "--rename-members") {
      options.renameMembers = true;
      continue;
    }
    if (arg === "--no-rename-members") {
      options.renameMembers = false;
      continue;
    }
    if (arg === "--rename-homoglyphs") {
      options.renameHomoglyphs = true;
      continue;
    }
    if (arg === "--no-rename-homoglyphs") {
      options.renameHomoglyphs = false;
      continue;
    }
    if (arg === "--mask-globals") {
      options.maskGlobals = true;
      continue;
    }
    if (arg === "--no-mask-globals") {
      options.maskGlobals = false;
      continue;
    }
    if (arg === "--no-strings") {
      options.strings = false;
      continue;
    }
    if (arg === "--strings-split") {
      options.stringsSplit = true;
      continue;
    }
    if (arg === "--no-strings-split") {
      options.stringsSplit = false;
      continue;
    }
    if (arg === "--strings-split-min") {
      options.stringsSplitMin = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--strings-split-max-parts") {
      options.stringsSplitMaxParts = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--strings-segment-size") {
      options.stringsSegmentSize = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--strings-value-fallback") {
      options.stringsValueFallback = true;
      continue;
    }
    if (arg === "--no-strings-value-fallback") {
      options.stringsValueFallback = false;
      continue;
    }
    if (arg === "--const-array") {
      options.constArray = true;
      continue;
    }
    if (arg === "--no-const-array") {
      options.constArray = false;
      continue;
    }
    if (arg === "--const-array-threshold") {
      options.constArrayProbability = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--const-array-strings-only") {
      options.constArrayStringsOnly = true;
      continue;
    }
    if (arg === "--no-const-array-strings-only") {
      options.constArrayStringsOnly = false;
      continue;
    }
    if (arg === "--const-array-shuffle") {
      options.constArrayShuffle = true;
      continue;
    }
    if (arg === "--no-const-array-shuffle") {
      options.constArrayShuffle = false;
      continue;
    }
    if (arg === "--const-array-rotate") {
      options.constArrayRotate = true;
      continue;
    }
    if (arg === "--no-const-array-rotate") {
      options.constArrayRotate = false;
      continue;
    }
    if (arg === "--const-array-encoding") {
      options.constArrayEncoding = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--const-array-wrapper") {
      options.constArrayWrapper = true;
      continue;
    }
    if (arg === "--no-const-array-wrapper") {
      options.constArrayWrapper = false;
      continue;
    }
    if (arg === "--numbers-expr") {
      options.numbersExpr = true;
      continue;
    }
    if (arg === "--no-numbers-expr") {
      options.numbersExpr = false;
      continue;
    }
    if (arg === "--numbers-expr-threshold") {
      options.numbersExprProbability = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--numbers-expr-inner") {
      options.numbersExprInner = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--numbers-expr-max-depth") {
      options.numbersExprMaxDepth = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--no-strings-object-keys") {
      options.stringsObjectKeys = false;
      continue;
    }
    if (arg === "--strings-object-keys") {
      options.stringsObjectKeys = true;
      continue;
    }
    if (arg === "--no-strings-jsx-attrs") {
      options.stringsJsxAttrs = false;
      continue;
    }
    if (arg === "--strings-jsx-attrs") {
      options.stringsJsxAttrs = true;
      continue;
    }
    if (arg === "--no-strings-template-chunks") {
      options.stringsTemplateChunks = false;
      continue;
    }
    if (arg === "--strings-template-chunks") {
      options.stringsTemplateChunks = true;
      continue;
    }
    if (arg === "--wrap") {
      options.wrap = true;
      continue;
    }
    if (arg === "--wrap-iterations") {
      options.wrapIterations = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--proxify-locals") {
      options.proxifyLocals = true;
      continue;
    }
    if (arg === "--no-proxify-locals") {
      options.proxifyLocals = false;
      continue;
    }
    if (arg === "--pad-footer") {
      options.padFooter = true;
      continue;
    }
    if (arg === "--no-pad-footer") {
      options.padFooter = false;
      continue;
    }
    if (arg === "--pad-footer-blocks") {
      options.padFooterBlocks = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--no-cff") {
      options.cff = false;
      continue;
    }
    if (arg === "--cff-downlevel") {
      options.cffDownlevel = true;
      continue;
    }
    if (arg === "--cff-mode") {
      options.cffMode = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--cff-opaque") {
      options.cffOpaque = true;
      continue;
    }
    if (arg === "--no-cff-opaque") {
      options.cffOpaque = false;
      continue;
    }
    if (arg === "--no-dead") {
      options.dead = false;
      continue;
    }
    if (arg === "--anti-hook") {
      options.antiHook = true;
      continue;
    }
    if (arg === "--anti-hook-lock") {
      options.antiHook = true;
      options.antiHookLock = true;
      continue;
    }
    positional.push(arg);
  }

  return { options, positional };
}

function readInput(file) {
  if (!file || file === "-") {
    return fs.readFileSync(0, "utf8");
  }
  return fs.readFileSync(file, "utf8");
}

function writeOutput(file, code) {
  if (!file) {
    process.stdout.write(code);
    return;
  }
  fs.writeFileSync(file, code, "utf8");
}

async function main() {
  const { options, positional } = parseArgs(process.argv);
  if (options.help || positional.length === 0) {
    printHelp();
    process.exit(options.help ? 0 : 1);
  }

  const inputPath = positional[0];
  const inputExt = inputPath === "-" ? "" : path.extname(inputPath).toLowerCase();
  const inferredLang =
    inputPath === "-"
      ? "js"
      : inputExt === ".lua" || inputExt === ".luau"
        ? "luau"
        : "js";
  const lang = options.lang || inferredLang;
  const source = readInput(inputPath);
  const outputPath = options.output
    ? options.output
    : inputPath === "-"
      ? null
      : path.join(
          path.dirname(inputPath),
          lang === "luau"
            ? `${path.basename(inputPath, path.extname(inputPath))}.obf${inputExt || ".lua"}`
            : `${path.basename(inputPath, path.extname(inputPath))}.obf.js`
        );

  const result = await obfuscate(source, {
    preset: options.preset,
    rename: options.rename,
    strings: options.strings,
    stringsOptions: {
      encodeObjectKeys: options.stringsObjectKeys,
      encodeJSXAttributes: options.stringsJsxAttrs,
      encodeTemplateChunks: options.stringsTemplateChunks,
      split: options.stringsSplit,
      splitMin: options.stringsSplitMin,
      splitMaxParts: options.stringsSplitMaxParts,
      segmentSize: options.stringsSegmentSize,
      encodeValueFallback: options.stringsValueFallback,
    },
    constArray: options.constArray,
    constArrayOptions: {
      probability: options.constArrayProbability,
      stringsOnly: options.constArrayStringsOnly,
      shuffle: options.constArrayShuffle,
      rotate: options.constArrayRotate,
      encoding: options.constArrayEncoding,
      wrapper: options.constArrayWrapper,
    },
    numbers: options.numbersExpr,
    numbersOptions: {
      probability: options.numbersExprProbability,
      innerProbability: options.numbersExprInner,
      maxDepth: options.numbersExprMaxDepth,
    },
    wrap: options.wrap,
    wrapOptions: {
      iterations: options.wrapIterations,
    },
    proxifyLocals: options.proxifyLocals,
    padFooter: options.padFooter,
    padFooterOptions: {
      blocks: options.padFooterBlocks,
    },
    cff: options.cff,
    cffOptions: {
      downlevel: options.cffDownlevel,
      mode: options.cffMode,
      opaque: options.cffOpaque,
    },
    dead: options.dead,
    antiHook: options.antiHook
      ? {
          enabled: true,
          lock: Boolean(options.antiHookLock),
        }
      : undefined,
    vm: {
      enabled: Boolean(options.vm),
      include: options.vmInclude,
      layers: options.vmLayers,
      topLevel: options.vmTopLevel,
      opcodeShuffle: options.vmOpcodeShuffle,
      fakeOpcodes: options.vmFakeOpcodes,
      bytecodeEncrypt: options.vmBytecode,
      constsEncrypt: options.vmConsts,
      constsEncoding: options.vmConstsEncoding,
      constsSplit: options.vmConstsSplit,
      constsSplitSize: options.vmConstsSplitSize,
      runtimeKey: options.vmRuntimeKey,
      runtimeSplit: options.vmRuntimeSplit,
      decoyRuntime: options.vmDecoyRuntime,
      decoyProbability: options.vmDecoyProbability,
      decoyStrings: options.vmDecoyStrings,
      blockDispatch: options.vmBlockDispatch,
      dispatchGraph: options.vmDispatchGraph,
      stackProtocol: options.vmStackProtocol,
      isaPolymorph: options.vmIsaPolymorph,
      fakeEdges: options.vmFakeEdges,
      numericStyle: options.vmNumericStyle,
      downlevel: options.vmDownlevel,
      debug: options.vmDebug,
    },
    seed: options.seed,
    ecma: options.ecma,
    sourceMap: options.sourcemap,
    compact: options.compact,
    minify: options.minify,
    beautify: options.beautify,
    timing: options.timing,
    filename: inputPath === "-" ? "stdin.js" : inputPath,
    lang,
    luauParser: options.luauParser,
    renameOptions: {
      renameGlobals: options.renameGlobals,
      renameMembers: options.renameMembers,
      homoglyphs: options.renameHomoglyphs,
      maskGlobals: options.maskGlobals,
    },
  });

  let outputCode = result.code;
  if (result.map && outputPath) {
    const mapPath = `${outputPath}.map`;
    fs.writeFileSync(mapPath, JSON.stringify(result.map), "utf8");
    outputCode += `\n//# sourceMappingURL=${path.basename(mapPath)}\n`;
  }

  writeOutput(outputPath, outputCode);
}

main().catch((err) => {
  process.stderr.write(`${err && err.stack ? err.stack : err}\n`);
  process.exit(1);
});
