#!/usr/bin/env node

const fs = require("fs");
const path = require("path");
const { obfuscate } = require("../src/index");

function printHelp() {
  const text = `
Usage:
  js-obf <input.js|input.lua|input.luau|-> [options]

Options:
  -o, --output <file>        Output file
  --preset <high|balanced|low>  Preset strength (default: high)
  --no-rename                Disable identifier renaming
  --rename-globals           Rename global bindings (Luau only)
  --no-rename-globals        Skip renaming globals
  --rename-members           Rename member/table keys (Luau only)
  --no-rename-members        Skip renaming members
  --rename-homoglyphs        Use l/I/1 homoglyph alphabet (Luau only)
  --no-rename-homoglyphs     Disable homoglyph alphabet
  --no-strings               Disable string encoding
  --strings-split            Split long strings into fragments (Luau)
  --no-strings-split         Disable string splitting
  --strings-split-min <n>    Minimum length to split (Luau, default 12)
  --strings-split-max-parts <n>  Max fragments (Luau, default 3)
  --no-strings-object-keys   Skip encoding object literal keys
  --strings-object-keys      Force encoding object literal keys
  --no-strings-jsx-attrs     Skip encoding JSX attribute string values
  --strings-jsx-attrs        Force encoding JSX attribute string values
  --no-strings-template-chunks  Skip encoding template literal static chunks
  --strings-template-chunks     Force encoding template literal static chunks
  --no-cff                   Disable control flow flattening
  --cff-downlevel            Allow CFF to downlevel let/const to var
  --cff-mode <vm|classic>    CFF strategy for Luau (default: vm)
  --cff-opaque               Enable opaque predicates (default: on)
  --no-cff-opaque            Disable opaque predicates
  --no-dead                  Disable dead code injection
  --vm                       Enable VM virtualization (see README limits)
  --vm-layers <n>            VM layers (Luau, default 1)
  --vm-include <a,b,c>        Only virtualize specified function names
  --vm-opcode-shuffle        Enable VM opcode shuffle (default: on)
  --no-vm-opcode-shuffle     Disable VM opcode shuffle
  --vm-fake-opcodes <0-1>    Fake opcode insertion probability (default: 0.15)
  --vm-bytecode              Encrypt VM bytecode at runtime (default: on)
  --no-vm-bytecode           Disable VM bytecode encryption
  --vm-consts                Encrypt VM const pool at runtime (default: on)
  --no-vm-consts             Disable VM const pool encryption
  --vm-runtime-key           Runtime key for Luau VM bytecode (default: on)
  --no-vm-runtime-key        Disable runtime key for Luau VM bytecode
  --vm-runtime-split         Split Luau VM bytecode into parts (default: on)
  --no-vm-runtime-split      Disable runtime bytecode split
  --vm-downlevel             Allow VM to downlevel let/const to var
  --anti-hook                Enable anti-hook runtime guard
  --anti-hook-lock           Freeze built-in prototypes after guard
  --lang <js|luau>            Select language (default: js, inferred from .lua/.luau)
  --luau-parser <luaparse|custom>  Luau parser backend (default: luaparse)
  --seed <value>              RNG seed
  --ecma <version>           Terser output ECMAScript version (default: 2020)
  --sourcemap                Emit source map
  --compact                  Compact output
  --no-minify                Skip Terser minification
  --beautify                 Beautify Terser output (multi-line, requires minify)
  -h, --help                 Show help
`;
  process.stdout.write(text);
}

function parseArgs(argv) {
  const args = argv.slice(2);
  const options = {
    preset: "high",
  };
  const positional = [];

  for (let i = 0; i < args.length; i += 1) {
    const arg = args[i];
    if (arg === "-h" || arg === "--help") {
      options.help = true;
      continue;
    }
    if (arg === "-o" || arg === "--output") {
      options.output = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--preset") {
      options.preset = args[i + 1] || "high";
      i += 1;
      continue;
    }
    if (arg === "--seed") {
      options.seed = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--lang") {
      options.lang = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--luau") {
      options.lang = "luau";
      continue;
    }
    if (arg === "--luau-parser") {
      options.luauParser = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--ecma") {
      options.ecma = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--sourcemap") {
      options.sourcemap = true;
      continue;
    }
    if (arg === "--compact") {
      options.compact = true;
      continue;
    }
    if (arg === "--no-minify") {
      options.minify = false;
      continue;
    }
    if (arg === "--beautify") {
      options.beautify = true;
      continue;
    }
    if (arg === "--vm") {
      options.vm = true;
      continue;
    }
    if (arg === "--vm-layers") {
      options.vmLayers = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--vm-include") {
      options.vmInclude = (args[i + 1] || "").split(",").filter(Boolean);
      i += 1;
      continue;
    }
    if (arg === "--vm-opcode-shuffle") {
      options.vmOpcodeShuffle = true;
      continue;
    }
    if (arg === "--no-vm-opcode-shuffle") {
      options.vmOpcodeShuffle = false;
      continue;
    }
    if (arg === "--vm-fake-opcodes") {
      options.vmFakeOpcodes = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--vm-bytecode") {
      options.vmBytecode = true;
      continue;
    }
    if (arg === "--no-vm-bytecode") {
      options.vmBytecode = false;
      continue;
    }
    if (arg === "--vm-consts") {
      options.vmConsts = true;
      continue;
    }
    if (arg === "--no-vm-consts") {
      options.vmConsts = false;
      continue;
    }
    if (arg === "--vm-runtime-key") {
      options.vmRuntimeKey = true;
      continue;
    }
    if (arg === "--no-vm-runtime-key") {
      options.vmRuntimeKey = false;
      continue;
    }
    if (arg === "--vm-runtime-split") {
      options.vmRuntimeSplit = true;
      continue;
    }
    if (arg === "--no-vm-runtime-split") {
      options.vmRuntimeSplit = false;
      continue;
    }
    if (arg === "--vm-downlevel") {
      options.vmDownlevel = true;
      continue;
    }
    if (arg === "--no-rename") {
      options.rename = false;
      continue;
    }
    if (arg === "--rename-globals") {
      options.renameGlobals = true;
      continue;
    }
    if (arg === "--no-rename-globals") {
      options.renameGlobals = false;
      continue;
    }
    if (arg === "--rename-members") {
      options.renameMembers = true;
      continue;
    }
    if (arg === "--no-rename-members") {
      options.renameMembers = false;
      continue;
    }
    if (arg === "--rename-homoglyphs") {
      options.renameHomoglyphs = true;
      continue;
    }
    if (arg === "--no-rename-homoglyphs") {
      options.renameHomoglyphs = false;
      continue;
    }
    if (arg === "--no-strings") {
      options.strings = false;
      continue;
    }
    if (arg === "--strings-split") {
      options.stringsSplit = true;
      continue;
    }
    if (arg === "--no-strings-split") {
      options.stringsSplit = false;
      continue;
    }
    if (arg === "--strings-split-min") {
      options.stringsSplitMin = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--strings-split-max-parts") {
      options.stringsSplitMaxParts = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--no-strings-object-keys") {
      options.stringsObjectKeys = false;
      continue;
    }
    if (arg === "--strings-object-keys") {
      options.stringsObjectKeys = true;
      continue;
    }
    if (arg === "--no-strings-jsx-attrs") {
      options.stringsJsxAttrs = false;
      continue;
    }
    if (arg === "--strings-jsx-attrs") {
      options.stringsJsxAttrs = true;
      continue;
    }
    if (arg === "--no-strings-template-chunks") {
      options.stringsTemplateChunks = false;
      continue;
    }
    if (arg === "--strings-template-chunks") {
      options.stringsTemplateChunks = true;
      continue;
    }
    if (arg === "--no-cff") {
      options.cff = false;
      continue;
    }
    if (arg === "--cff-downlevel") {
      options.cffDownlevel = true;
      continue;
    }
    if (arg === "--cff-mode") {
      options.cffMode = args[i + 1];
      i += 1;
      continue;
    }
    if (arg === "--cff-opaque") {
      options.cffOpaque = true;
      continue;
    }
    if (arg === "--no-cff-opaque") {
      options.cffOpaque = false;
      continue;
    }
    if (arg === "--no-dead") {
      options.dead = false;
      continue;
    }
    if (arg === "--anti-hook") {
      options.antiHook = true;
      continue;
    }
    if (arg === "--anti-hook-lock") {
      options.antiHook = true;
      options.antiHookLock = true;
      continue;
    }
    positional.push(arg);
  }

  return { options, positional };
}

function readInput(file) {
  if (!file || file === "-") {
    return fs.readFileSync(0, "utf8");
  }
  return fs.readFileSync(file, "utf8");
}

function writeOutput(file, code) {
  if (!file) {
    process.stdout.write(code);
    return;
  }
  fs.writeFileSync(file, code, "utf8");
}

async function main() {
  const { options, positional } = parseArgs(process.argv);
  if (options.help || positional.length === 0) {
    printHelp();
    process.exit(options.help ? 0 : 1);
  }

  const inputPath = positional[0];
  const inputExt = inputPath === "-" ? "" : path.extname(inputPath).toLowerCase();
  const inferredLang =
    inputPath === "-"
      ? "js"
      : inputExt === ".lua" || inputExt === ".luau"
        ? "luau"
        : "js";
  const lang = options.lang || inferredLang;
  const source = readInput(inputPath);
  const outputPath = options.output
    ? options.output
    : inputPath === "-"
      ? null
      : path.join(
          path.dirname(inputPath),
          lang === "luau"
            ? `${path.basename(inputPath, path.extname(inputPath))}.obf${inputExt || ".lua"}`
            : `${path.basename(inputPath, path.extname(inputPath))}.obf.js`
        );

  const result = await obfuscate(source, {
    preset: options.preset,
    rename: options.rename,
    strings: options.strings,
    stringsOptions: {
      encodeObjectKeys: options.stringsObjectKeys,
      encodeJSXAttributes: options.stringsJsxAttrs,
      encodeTemplateChunks: options.stringsTemplateChunks,
      split: options.stringsSplit,
      splitMin: options.stringsSplitMin,
      splitMaxParts: options.stringsSplitMaxParts,
    },
    cff: options.cff,
    cffOptions: {
      downlevel: options.cffDownlevel,
      mode: options.cffMode,
      opaque: options.cffOpaque,
    },
    dead: options.dead,
    antiHook: options.antiHook
      ? {
          enabled: true,
          lock: Boolean(options.antiHookLock),
        }
      : undefined,
    vm: {
      enabled: Boolean(options.vm),
      include: options.vmInclude,
      layers: options.vmLayers,
      opcodeShuffle: options.vmOpcodeShuffle,
      fakeOpcodes: options.vmFakeOpcodes,
      bytecodeEncrypt: options.vmBytecode,
      constsEncrypt: options.vmConsts,
      runtimeKey: options.vmRuntimeKey,
      runtimeSplit: options.vmRuntimeSplit,
      downlevel: options.vmDownlevel,
    },
    seed: options.seed,
    ecma: options.ecma,
    sourceMap: options.sourcemap,
    compact: options.compact,
    minify: options.minify,
    beautify: options.beautify,
    filename: inputPath === "-" ? "stdin.js" : inputPath,
    lang,
    luauParser: options.luauParser,
    renameOptions: {
      renameGlobals: options.renameGlobals,
      renameMembers: options.renameMembers,
      homoglyphs: options.renameHomoglyphs,
    },
  });

  let outputCode = result.code;
  if (result.map && outputPath) {
    const mapPath = `${outputPath}.map`;
    fs.writeFileSync(mapPath, JSON.stringify(result.map), "utf8");
    outputCode += `\n//# sourceMappingURL=${path.basename(mapPath)}\n`;
  }

  writeOutput(outputPath, outputCode);
}

main().catch((err) => {
  process.stderr.write(`${err && err.stack ? err.stack : err}\n`);
  process.exit(1);
});
